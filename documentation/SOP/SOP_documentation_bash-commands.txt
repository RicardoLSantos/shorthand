#!/bin/bash
# Comandos Bash 2.5 macOS para gest√£o dos SOPs e atualiza√ß√£o de reposit√≥rios
# Data: 2024
# Compat√≠vel com macOS bash 2.5

# ==============================================================================
# PARTE 1: CRIA√á√ÉO DA ESTRUTURA DE DIRET√ìRIOS PARA SOPs
# ==============================================================================

echo "üîß Criando estrutura de diret√≥rios para SOPs..."

# Criar diret√≥rio principal de documenta√ß√£o
mkdir -p ./documentation/SOPs
mkdir -p ./documentation/SOPs/markdown
mkdir -p ./documentation/SOPs/pdf
mkdir -p ./documentation/templates
mkdir -p ./documentation/references

# ==============================================================================
# PARTE 2: CRIA√á√ÉO DOS ARQUIVOS SOPs EM MARKDOWN
# ==============================================================================

echo "üìù Criando arquivos SOPs em formato Markdown..."

# Criar SOP-001: Fundamentos de Implementation Guides
cat > ./documentation/SOPs/markdown/SOP-001-IG-Fundamentals.md << 'EOF'
[Conte√∫do completo do SOP-001 aqui - copiar do artifact sop-ig-fundamentals]
EOF

# Criar SOP-002: Terminologias
cat > ./documentation/SOPs/markdown/SOP-002-Terminologies.md << 'EOF'
[Conte√∫do completo do SOP-002 aqui - copiar do artifact sop-terminologies]
EOF

# Criar SOP-003: Privacidade e Seguran√ßa
cat > ./documentation/SOPs/markdown/SOP-003-Privacy-Security.md << 'EOF'
[Conte√∫do completo do SOP-003 aqui - copiar do artifact sop-privacy-security]
EOF

# ==============================================================================
# PARTE 3: CRIA√á√ÉO DO √çNDICE MESTRE
# ==============================================================================

echo "üìö Criando √≠ndice mestre de documenta√ß√£o..."

cat > ./documentation/README.md << 'EOF'
# Documenta√ß√£o de Implementation Guides FHIR

## Standard Operating Procedures (SOPs)

### SOPs Fundamentais

1. **[SOP-001: Fundamentos de Implementation Guides FHIR](SOPs/markdown/SOP-001-IG-Fundamentals.md)**
   - Estrutura e componentes de IGs
   - Processo de desenvolvimento
   - Ferramentas e tecnologias

2. **[SOP-002: Terminologias e Vocabul√°rios em FHIR](SOPs/markdown/SOP-002-Terminologies.md)**
   - SNOMED CT, LOINC, ICD-10/11
   - CodeSystems e ValueSets
   - Mapeamento e tradu√ß√£o

3. **[SOP-003: Pol√≠ticas de Privacidade e Seguran√ßa](SOPs/markdown/SOP-003-Privacy-Security.md)**
   - Conformidade LGPD, GDPR, HIPAA
   - Seguran√ßa e criptografia
   - Gest√£o de consentimento

## Templates

- [Template de Profile](templates/profile-template.fsh)
- [Template de Extension](templates/extension-template.fsh)
- [Template de ValueSet](templates/valueset-template.fsh)
- [Template de IG Config](templates/sushi-config-template.yaml)

## Refer√™ncias R√°pidas

- [Comandos FSH](references/fsh-quick-reference.md)
- [Checklist de Publica√ß√£o](references/publication-checklist.md)
- [Troubleshooting Guide](references/troubleshooting.md)

---
√öltima atualiza√ß√£o: $(date +"%Y-%m-%d")
EOF

# ==============================================================================
# PARTE 4: CONVERS√ÉO PARA PDF (Requer pandoc e LaTeX)
# ==============================================================================

echo "üìÑ Convertendo SOPs para PDF..."

# Verificar se pandoc est√° instalado
if command -v pandoc &> /dev/null; then
    # Converter cada SOP para PDF
    for sop in ./documentation/SOPs/markdown/*.md; do
        filename=$(basename "$sop" .md)
        echo "   Convertendo $filename para PDF..."
        pandoc "$sop" \
            -o "./documentation/SOPs/pdf/${filename}.pdf" \
            --pdf-engine=xelatex \
            --toc \
            --toc-depth=3 \
            --highlight-style=tango \
            -V geometry:margin=1in \
            -V mainfont="Helvetica Neue" \
            -V monofont="Courier New" \
            -V fontsize=11pt \
            -V urlcolor=blue \
            -V linkcolor=blue \
            2>/dev/null || echo "   ‚ö†Ô∏è  Erro ao converter $filename"
    done
else
    echo "‚ö†Ô∏è  pandoc n√£o instalado. Instale com: brew install pandoc"
    echo "   Para PDFs, tamb√©m instale: brew install --cask mactex-no-gui"
fi

# ==============================================================================
# PARTE 5: CRIA√á√ÉO DE TEMPLATES FSH
# ==============================================================================

echo "üé® Criando templates FSH..."

# Template de Profile
cat > ./documentation/templates/profile-template.fsh << 'EOF'
// Template de Profile FHIR
// Substitua os valores entre colchetes

Profile: [NomeDoPerfil]
Parent: [RecursoOuPerfilBase]
Id: [id-unico-do-perfil]
Title: "[T√≠tulo Leg√≠vel do Perfil]"
Description: "[Descri√ß√£o detalhada do perfil e seu uso]"

// Metadados
* ^url = "http://example.org/fhir/StructureDefinition/[id-unico-do-perfil]"
* ^version = "1.0.0"
* ^status = #draft
* ^date = "2024-01-01"
* ^publisher = "[Sua Organiza√ß√£o]"
* ^contact.name = "[Nome do Contato]"
* ^contact.telecom.system = #email
* ^contact.telecom.value = "[email@organizacao.com]"

// Regras do Perfil
* [elemento] [cardinalidade] [flags] "[descri√ß√£o curta]" "[defini√ß√£o]"
// Exemplo:
// * identifier 1..* MS "Identificador do paciente" "Identificador √∫nico do paciente no sistema"
// * name 1..* MS
// * birthDate 1..1 MS
EOF

# Template de Extension
cat > ./documentation/templates/extension-template.fsh << 'EOF'
// Template de Extension FHIR
Extension: [NomeDaExtension]
Id: [id-da-extension]
Title: "[T√≠tulo da Extension]"
Description: "[Descri√ß√£o do uso da extension]"
Context: [Recurso(s) onde pode ser usada]

// Estrutura da Extension
* value[x] only [tipo de dado]
* value[x] 1..1 MS
// Para extensions complexas:
// * extension contains
//     sub1 1..1 MS and
//     sub2 0..* MS
// * extension[sub1].value[x] only string
// * extension[sub2].value[x] only CodeableConcept
EOF

# Template de ValueSet
cat > ./documentation/templates/valueset-template.fsh << 'EOF'
// Template de ValueSet FHIR
ValueSet: [NomeDoValueSet]
Id: [id-do-valueset]
Title: "[T√≠tulo do ValueSet]"
Description: "[Descri√ß√£o do conjunto de valores e seu uso]"

// Metadados
* ^url = "http://example.org/fhir/ValueSet/[id-do-valueset]"
* ^version = "1.0.0"
* ^status = #draft
* ^experimental = false

// Inclus√£o de c√≥digos (escolha um m√©todo)

// M√©todo 1: Lista expl√≠cita (Extensional)
* $SystemAlias#code1 "Display 1"
* $SystemAlias#code2 "Display 2"

// M√©todo 2: Por filtro (Intensional)
* include codes from system $SystemAlias where concept is-a #parent-code

// M√©todo 3: Incluir ValueSet existente
* include codes from valueset ExistingValueSetURL
EOF

# ==============================================================================
# PARTE 6: CONFIGURA√á√ÉO DO GIT
# ==============================================================================

echo "üîÑ Configurando Git..."

# Criar .gitignore se n√£o existir
cat > .gitignore << 'EOF'
# FHIR IG Build Artifacts
/output/
/fsh-generated/
/input-cache/
/temp/
/template/

# IDE
.idea/
*.iml
.vscode/
*.code-workspace

# OS
.DS_Store
Thumbs.db

# Logs
*.log
tx.log
validation-*.json

# Backup files
*.bak
*~
*.swp

# Dependencies
node_modules/
package-lock.json

# Generated documentation
documentation/SOPs/pdf/*.pdf

# Local configuration
local-config.yaml
*.local.*
EOF

# Criar .gitattributes
cat > .gitattributes << 'EOF'
# Auto detect text files
* text=auto

# FSH files
*.fsh text eol=lf
*.yaml text eol=lf
*.yml text eol=lf
*.json text eol=lf

# Documentation
*.md text eol=lf
*.txt text eol=lf

# Scripts
*.sh text eol=lf
*.bat text eol=crlf

# Binary files
*.pdf binary
*.png binary
*.jpg binary
*.jpeg binary
EOF

# ==============================================================================
# PARTE 7: COMMIT E PUSH PARA GITHUB
# ==============================================================================

echo "üì§ Preparando commit para GitHub..."

# Adicionar todos os arquivos novos
git add -A

# Criar commit com mensagem descritiva
git commit -m "üìö Add SOPs fundamentais para desenvolvimento de IGs FHIR

- SOP-001: Fundamentos de Implementation Guides
- SOP-002: Terminologias e Vocabul√°rios
- SOP-003: Pol√≠ticas de Privacidade e Seguran√ßa
- Templates FSH para desenvolvimento
- Estrutura de documenta√ß√£o completa

Co-authored-by: HL7 FHIR Team <fhir@hl7.org>"

# Verificar branch atual
CURRENT_BRANCH=$(git branch --show-current)
echo "   Branch atual: $CURRENT_BRANCH"

# Push para GitHub
echo "   Enviando para GitHub..."
git push origin "$CURRENT_BRANCH" || {
    echo "‚ö†Ô∏è  Erro no push para GitHub. Tentando configurar remote..."
    git remote add origin https://github.com/[seu-usuario]/[seu-repositorio].git 2>/dev/null
    git push -u origin "$CURRENT_BRANCH"
}

# ==============================================================================
# PARTE 8: SINCRONIZA√á√ÉO COM RADICLE
# ==============================================================================

echo "üå± Sincronizando com Radicle..."

# Verificar se rad est√° instalado
if command -v rad &> /dev/null; then
    # Inicializar projeto Radicle se necess√°rio
    if [ ! -d ".radicle" ]; then
        echo "   Inicializando projeto Radicle..."
        rad init \
            --name "FHIR-IG-SOPs" \
            --description "Standard Operating Procedures para Implementation Guides FHIR" \
            --default-branch "$CURRENT_BRANCH" \
            --public
    fi
    
    # Sincronizar com Radicle
    rad sync
    
    # Publicar altera√ß√µes
    rad push
    
    echo "‚úÖ Sincronizado com Radicle"
    
    # Mostrar ID do projeto Radicle
    RAD_ID=$(rad ls | grep "FHIR-IG-SOPs" | awk '{print $1}')
    echo "   Radicle Project ID: $RAD_ID"
else
    echo "‚ö†Ô∏è  rad n√£o instalado. Instale com as instru√ß√µes em: https://radicle.xyz/install"
fi

# ==============================================================================
# PARTE 9: VALIDA√á√ÉO DOS ARQUIVOS FSH
# ==============================================================================

echo "‚úîÔ∏è Validando arquivos FSH..."

# Verificar se sushi est√° instalado
if command -v sushi &> /dev/null; then
    # Validar sintaxe FSH
    for fsh_file in input/fsh/*.fsh documentation/templates/*.fsh; do
        if [ -f "$fsh_file" ]; then
            echo "   Validando: $(basename "$fsh_file")"
            sushi "$fsh_file" --snapshot 2>/dev/null || echo "   ‚ö†Ô∏è  Avisos em $(basename "$fsh_file")"
        fi
    done
else
    echo "‚ö†Ô∏è  SUSHI n√£o instalado. Instale com: npm install -g fsh-sushi"
fi

# ==============================================================================
# PARTE 10: GERA√á√ÉO DE RELAT√ìRIO DE STATUS
# ==============================================================================

echo "üìä Gerando relat√≥rio de status..."

cat > ./documentation/status-report.md << EOF
# Relat√≥rio de Status do Projeto
**Data:** $(date +"%Y-%m-%d %H:%M:%S")
**Branch:** $CURRENT_BRANCH

## SOPs Criados
- ‚úÖ SOP-001: Fundamentos de Implementation Guides
- ‚úÖ SOP-002: Terminologias e Vocabul√°rios  
- ‚úÖ SOP-003: Pol√≠ticas de Privacidade e Seguran√ßa

## Estrutura de Arquivos
\`\`\`
$(tree -L 3 ./documentation 2>/dev/null || find ./documentation -type f -name "*.md" | head -20)
\`\`\`

## Pr√≥ximos Passos
1. Revisar SOPs com a equipe
2. Adicionar exemplos pr√°ticos
3. Criar casos de teste
4. Documentar li√ß√µes aprendidas

## Informa√ß√µes do Reposit√≥rio
- **GitHub:** https://github.com/[seu-usuario]/[seu-repositorio]
- **Radicle ID:** ${RAD_ID:-"N√£o configurado"}
- **√öltimo Commit:** $(git log -1 --format="%h - %s")
EOF

# ==============================================================================
# PARTE 11: SCRIPT DE AUTOMA√á√ÉO PARA ATUALIZA√á√ïES FUTURAS
# ==============================================================================

echo "ü§ñ Criando script de automa√ß√£o..."

cat > ./update-and-sync.sh << 'EOF'
#!/bin/bash
# Script de automa√ß√£o para atualizar documenta√ß√£o e sincronizar reposit√≥rios

set -e

echo "üîÑ Iniciando processo de atualiza√ß√£o..."

# 1. Atualizar timestamp nos documentos
find ./documentation/SOPs/markdown -name "*.md" -exec sed -i '' \
    "s/Data de vig√™ncia: .*/Data de vig√™ncia: $(date +%Y)-$(($(date +%Y)+1))/" {} \;

# 2. Regenerar PDFs se pandoc dispon√≠vel
if command -v pandoc &> /dev/null; then
    echo "üìÑ Regenerando PDFs..."
    for md in ./documentation/SOPs/markdown/*.md; do
        pdf="./documentation/SOPs/pdf/$(basename "$md" .md).pdf"
        pandoc "$md" -o "$pdf" --pdf-engine=xelatex --toc 2>/dev/null || true
    done
fi

# 3. Validar FSH files
if command -v sushi &> /dev/null; then
    echo "‚úîÔ∏è Validando FSH..."
    sushi . 2>/dev/null || echo "Avisos encontrados"
fi

# 4. Git commit e push
echo "üì§ Commitando altera√ß√µes..."
git add -A
git commit -m "üîÑ Atualiza√ß√£o autom√°tica de documenta√ß√£o $(date +%Y-%m-%d)" || echo "Sem altera√ß√µes"
git push origin $(git branch --show-current)

# 5. Sincronizar com Radicle
if command -v rad &> /dev/null; then
    echo "üå± Sincronizando Radicle..."
    rad sync && rad push
fi

echo "‚úÖ Atualiza√ß√£o completa!"
EOF

chmod +x ./update-and-sync.sh

# ==============================================================================
# PARTE 12: CRIA√á√ÉO DE MAKEFILE PARA FACILITAR OPERA√á√ïES
# ==============================================================================

echo "üõ† Criando Makefile..."

cat > Makefile << 'EOF'
# Makefile para gest√£o de FHIR Implementation Guides
.PHONY: help build clean validate docs sync update all

# Vari√°veis
SUSHI := $(shell command -v sushi 2> /dev/null)
PANDOC := $(shell command -v pandoc 2> /dev/null)
RAD := $(shell command -v rad 2> /dev/null)

# Target padr√£o
help:
	@echo "Comandos dispon√≠veis:"
	@echo "  make build    - Compilar IG com SUSHI"
	@echo "  make validate - Validar arquivos FSH"
	@echo "  make docs     - Gerar documenta√ß√£o PDF"
	@echo "  make sync     - Sincronizar com Git e Radicle"
	@echo "  make clean    - Limpar arquivos gerados"
	@echo "  make update   - Atualizar e sincronizar tudo"
	@echo "  make all      - Executar build, docs e sync"

# Compilar IG
build:
ifdef SUSHI
	@echo "üî® Compilando IG com SUSHI..."
	@sushi .
	@./_genonce.sh || ./_genonce.bat
else
	@echo "‚ö†Ô∏è  SUSHI n√£o instalado"
endif

# Validar FSH
validate:
ifdef SUSHI
	@echo "‚úîÔ∏è Validando FSH files..."
	@find input/fsh -name "*.fsh" -exec sushi {} --snapshot \;
else
	@echo "‚ö†Ô∏è  SUSHI n√£o instalado"
endif

# Gerar documenta√ß√£o PDF
docs:
ifdef PANDOC
	@echo "üìÑ Gerando PDFs..."
	@mkdir -p documentation/SOPs/pdf
	@for f in documentation/SOPs/markdown/*.md; do \
		pandoc $f -o documentation/SOPs/pdf/$(basename $f .md).pdf \
			--pdf-engine=xelatex --toc 2>/dev/null || true; \
	done
else
	@echo "‚ö†Ô∏è  Pandoc n√£o instalado"
endif

# Sincronizar reposit√≥rios
sync:
	@echo "üîÑ Sincronizando..."
	@git add -A
	@git commit -m "Sync: $(date +%Y-%m-%d\ %H:%M:%S)" || true
	@git push origin $(git branch --show-current)
ifdef RAD
	@rad sync && rad push
endif

# Limpar arquivos gerados
clean:
	@echo "üßπ Limpando..."
	@rm -rf output/ fsh-generated/ input-cache/ temp/
	@find . -name "*.log" -delete
	@find . -name "*~" -delete

# Atualizar tudo
update: validate docs sync
	@echo "‚úÖ Atualiza√ß√£o completa"

# Build completo
all: clean build docs sync
	@echo "‚úÖ Build completo finalizado"
EOF

# ==============================================================================
# PARTE 13: HOOKS DO GIT PARA QUALIDADE
# ==============================================================================

echo "ü™ù Configurando Git hooks..."

mkdir -p .git/hooks

# Pre-commit hook
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
# Pre-commit hook para valida√ß√£o

echo "üîç Executando valida√ß√µes pre-commit..."

# Validar JSON
for file in $(git diff --cached --name-only --diff-filter=ACM | grep "\.json$"); do
    python -m json.tool "$file" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "‚ùå JSON inv√°lido: $file"
        exit 1
    fi
done

# Validar YAML
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(yaml|yml)$"); do
    python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null
    if [ $? -ne 0 ]; then
        echo "‚ùå YAML inv√°lido: $file"
        exit 1
    fi
done

echo "‚úÖ Valida√ß√µes conclu√≠das"
EOF

chmod +x .git/hooks/pre-commit

# ==============================================================================
# PARTE 14: RESUMO FINAL
# ==============================================================================

echo ""
echo "=================================================================================="
echo "‚úÖ CONFIGURA√á√ÉO COMPLETA!"
echo "=================================================================================="
echo ""
echo "üìÅ Estrutura criada:"
echo "   - documentation/SOPs/markdown/ (3 SOPs em Markdown)"
echo "   - documentation/SOPs/pdf/ (PDFs se pandoc instalado)"
echo "   - documentation/templates/ (Templates FSH)"
echo "   - Scripts de automa√ß√£o"
echo ""
echo "üìù SOPs criados:"
echo "   1. SOP-001: Fundamentos de IGs"
echo "   2. SOP-002: Terminologias"
echo "   3. SOP-003: Privacidade e Seguran√ßa"
echo ""
echo "üîß Pr√≥ximos comandos √∫teis:"
echo "   make build     # Compilar IG"
echo "   make docs      # Gerar PDFs"
echo "   make sync      # Sincronizar repos"
echo "   make all       # Fazer tudo"
echo "   ./update-and-sync.sh  # Script de atualiza√ß√£o"
echo ""
echo "üìö Para configurar GitHub:"
echo "   git remote add origin https://github.com/[usuario]/[repo].git"
echo "   git push -u origin main"
echo ""
echo "üå± Para configurar Radicle:"
echo "   rad init --name 'FHIR-IG-SOPs' --public"
echo "   rad push"
echo ""
echo "=================================================================================="
echo "üí° Dica: Execute 'make help' para ver todos os comandos dispon√≠veis"
echo "=================================================================================="