## REFERÊNCIAS

1. HAPI FHIR Documentation. Server Types and Architecture. 2024. https://hapifhir.io/hapi-fhir/docs/server_plain/introduction.html

2. HL7 International. FHIR Security. 2024. http://hl7.org/fhir/R5/security.html

3. HL7 International. FHIR Exchange Module. 2024. http://hl7.org/fhir/R5/exchange-module.html

4. HAPI FHIR. Performance Tuning. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/performance.html

5. HL7 International. FHIR R4. 2019. http://hl7.org/fhir/R4/

6. HL7 International. FHIR R5. 2024. http://hl7.org/fhir/R5/

7. Oracle. Java SE 17 Documentation. 2024. https://docs.oracle.com/en/java/javase/17/

8. HAPI FHIR. System Requirements. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/get_started.html

9. HAPI FHIR. Installation Guide. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/installation.html

10. TimescaleDB. Documentation. 2024. https://docs.timescale.com/

11. Microsoft. SQL Server JDBC Driver. 2024. https://docs.microsoft.com/en-us/sql/connect/jdbc/

12. Oracle. Database JDBC Developer's Guide. 2024. https://docs.oracle.com/en/database/oracle/oracle-database/21/jjdbc/

13. H2 Database. Documentation. 2024. http://www.h2database.com/html/main.html

14. Homebrew. Package Manager for macOS. 2024. https://brew.sh/

15. GitHub. HAPI FHIR JPA Server Starter. 2024. https://github.com/hapifhir/hapi-fhir-jpaserver-starter

16. Docker. Documentation. 2024. https://docs.docker.com/

17. TimescaleDB. Docker Image. 2024. https://hub.docker.com/r/timescale/timescaledb

18. HAPI Project. Docker Image. 2024. https://hub.docker.com/r/hapiproject/hapi

19. HL7 International. FHIR R4 Specification. 2019. http://hl7.org/fhir/R4/

20. HAPI FHIR. Subscriptions. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/subscription.html

21. HAPI FHIR. WebSocket Subscriptions. 2024. https://hapifhir.io/hapi-fhir/docs/server_plain/websocket_subscriptions.html

22. HL7 International. Bulk Data Access. 2024. http://hl7.org/fhir/uv/bulkdata/

23. PostgreSQL. Connection Strings. 2024. https://www.postgresql.org/docs/current/libpq-connect.html

24. HAPI FHIR. Database Configuration. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/database_support.html

25. TimescaleDB. Hypertables. 2024. https://docs.timescale.com/use-timescaledb/latest/hypertables/

26. HL7 International. Device Resource. 2024. http://hl7.org/fhir/R4/device.html

27. HL7 International. Observation Resource. 2024. http://hl7.org/fhir/R4/observation.html

28. RFC 6749. OAuth 2.0 Authorization Framework. 2012. https://datatracker.ietf.org/doc/html/rfc6749

29. HL7 International. SMART on FHIR. 2024. http://hl7.org/fhir/smart-app-launch/

30. NIST. AES Specification. 2001. https://csrc.nist.gov/publications/detail/fips/197/final

31. OWASP. Key Management Cheat Sheet. 2024. https://cheatsheetseries.owasp.org/cheatsheets/Key_Management_Cheat_Sheet.html

32. RFC 8446. TLS 1.3. 2018. https://datatracker.ietf.org/doc/html/rfc8446

33. RFC 6797. HTTP Strict Transport Security. 2012. https://datatracker.ietf.org/doc/html/rfc6797

34. W3C. Content Security Policy. 2024. https://www.w3.org/TR/CSP3/

35. HL7 International. Audit Logging. 2024. http://hl7.org/fhir/R4/security.html#audit

36. HIPAA. Administrative Safeguards. 45 CFR 164.312(b). https://www.hhs.gov/hipaa/for-professionals/security/laws-regulations/

37. LOINC 8867-4. Heart rate. 2024. https://loinc.org/8867-4/

38. LOINC 8480-6. Systolic blood pressure. 2024. https://loinc.org/8480-6/

39. LOINC 2708-6. Oxygen saturation. 2024. https://loinc.org/2708-6/

40. LOINC 80404-7. Heart rate variability. 2024. https://loinc.org/80404-7/

41. LOINC 41950-7. 24 hour step count. 2024. https://loinc.org/41950-7/

42. LOINC 77592-4. Moderate physical activity. 2024. https://loinc.org/77592-4/

43. LOINC 93832-4. Sleep duration. 2024. https://loinc.org/93832-4/

44. LOINC 93831-6. Sleep efficiency. 2024. https://loinc.org/93831-6/

45. LOINC 33747-0. Caloric intake. 2024. https://loinc.org/33747-0/

46. LOINC 73985-4. Water intake. 2024. https://loinc.org/73985-4/

47. SNOMED CT 129006008. Walking. 2024. https://browser.ihtsdotools.org/?perspective=full&conceptId1=129006008

48. SNOMED CT 418060005. Running. 2024. https://browser.ihtsdotools.org/?perspective=full&conceptId1=418060005

49. SNOMED CT 70582002. Cycling. 2024. https://browser.ihtsdotools.org/?perspective=full&conceptId1=70582002

50. SNOMED CT 248263006. Sleep duration. 2024. https://browser.ihtsdotools.org/?perspective=full&conceptId1=248263006

51. SNOMED CT 248262001. Sleep quality. 2024. https://browser.ihtsdotools.org/?perspective=full&conceptId1=248262001

52. SNOMED CT 276239002. Meditation. 2024. https://browser.ihtsdotools.org/?perspective=full&conceptId1=276239002

53. SNOMED CT 385893007. Stress reduction. 2024. https://browser.ihtsdotools.org/?perspective=full&conceptId1=385893007

54. openEHR Foundation. REST API Specification. 2024. https://specifications.openehr.org/releases/ITS-REST/latest/

55. openEHR Foundation. FHIR Integration. 2024. https://specifications.openehr.org/releases/ITS-FHIR/latest/

56. OHDSI Collaborative. OMOP CDM. 2024. https://ohdsi.github.io/CommonDataModel/

57. IHE. Mobile Health Documents. 2024. https://profiles.ihe.net/ITI/MHD/

58. IHE. Patient Identifier Cross-Reference. 2024. https://profiles.ihe.net/ITI/PIXm/

59. IHE. Patient Demographics Query. 2024. https://profiles.ihe.net/ITI/PDQm/

60. IHE. Cross-Community Access. 2024. https://profiles.ihe.net/ITI/XCA/

61. HAPI FHIR. Search Coordination. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/search.html

62. HAPI FHIR. Pagination. 2024. https://hapifhir.io/hapi-fhir/docs/server_plain/paging.html

63. HAPI FHIR. Search Parameters. 2024. https://hapifhir.io/hapi-fhir/docs/server_plain/search.html

64. HikariCP. Configuration. 2024. https://github.com/brettwooldridge/HikariCP

65. HikariCP. Pool Sizing. 2024. https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing

66. HikariCP. Timeouts. 2024. https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby

67. Prometheus. Documentation. 2024. https://prometheus.io/docs/

68. Grafana Labs. Documentation. 2024. https://grafana.com/docs/

69. HAPI FHIR. Docker Deployment. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/deploying_via_docker.html

70. Spring Boot. Actuator Endpoints. 2024. https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html

71. Grafana. Dashboard JSON Model. 2024. https://grafana.com/docs/grafana/latest/dashboards/json-model/

72. PostgreSQL. pg_dump Documentation. 2024. https://www.postgresql.org/docs/current/app-pgdump.html

73. PostgreSQL. Backup Strategies. 2024. https://www.postgresql.org/docs/current/backup.html

74. TimescaleDB. Backup and Recovery. 2024. https://docs.timescale.com/self-hosted/latest/backup-and-restore/

75. AWS S3. CLI Documentation. 2024. https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3.html

76. HAPI FHIR. Search Operations. 2024. https://hapifhir.io/hapi-fhir/docs/server_plain/rest_operations_search.html

77. HAPI FHIR. Custom Operations. 2024. https://hapifhir.io/hapi-fhir/docs/server_plain/rest_operations_operations.html

78. Apple Developer. HealthKit. 2024. https://developer.apple.com/documentation/healthkit

79. Apple Developer. HKQuantityType. 2024. https://developer.apple.com/documentation/healthkit/hkquantitytype

80. Google Developers. Google Fit API. 2024. https://developers.google.com/fit

81. Google Fit. Data Types. 2024. https://developers.google.com/fit/datatypes

82. Radicle. Documentation. 2024. https://radicle.xyz/docs

83. Hyperledger. Fabric Documentation. 2024. https://hyperledger-fabric.readthedocs.io/

84. Hyperledger. Network Setup. 2024. https://hyperledger-fabric.readthedocs.io/en/latest/network/network.html

85. Hyperledger. Smart Contracts. 2024. https://hyperledger-fabric.readthedocs.io/en/latest/smartcontract/smartcontract.html

86. Hyperledger. Private Data. 2024. https://hyperledger-fabric.readthedocs.io/en/latest/private-data/private-data.html

87. W3C. DID Core Specification. 2022. https://www.w3.org/TR/did-core/

88. HL7 International. TestScript Resource. 2024. http://hl7.org/fhir/R4/testscript.html

89. curl Documentation. 2024. https://curl.se/docs/

90. FHIR CRUD Operations. 2024. http://hl7.org/fhir/R4/http.html#create

91. Kubernetes. Deployment Strategies. 2024. https://kubernetes.io/docs/concepts/workloads/controllers/deployment/

92. Backup Best Practices. PostgreSQL. 2024. https://www.postgresql.org/docs/current/backup.html

93. Blue-Green Deployment. Martin Fowler. 2010. https://martinfowler.com/bliki/BlueGreenDeployment.html

94. GitHub. Git Documentation. 2024. https://docs.github.com/

95. Radicle. Protocol Guide. 2024. https://radicle.xyz/guides/protocol

96. Linux. System Administration. 2024. https://www.kernel.org/doc/

97. Network Diagnostics. curl. 2024. https://everything.curl.dev/

98. Linux Performance Monitoring. 2024. https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html

99. Docker. Logging. 2024. https://docs.docker.com/config/containers/logging/

100. HAPI FHIR. Maintenance Operations. 2024. https://hapifhir.io/hapi-fhir/docs/server_jpa/upgrading.html

---
**Documento aprovado por:** [Comitê de Infraestrutura e DevOps]  
**Data de vigência:** 2024-2025  
**Próxima revisão:** Janeiro 2026# SOP-012: Instalação, Configuração e Manutenção de Servidor HAPI FHIR para Medicina do Estilo de Vida

## Resumo Executivo

Este Standard Operating Procedure (SOP) fornece orientações completas e detalhadas para instalação, configuração e manutenção de servidor HAPI FHIR local (on-premises) especializado em medicina do estilo de vida e dados coletados de dispositivos wearables¹. O documento abrange desde instalação básica até configurações avançadas de segurança², interoperabilidade³ e performance⁴.

## 1. Especificações e Pré-requisitos do Sistema

### 1.1 Especificações Oficiais HL7 FHIR

- **Versão FHIR**: R4 (4.0.1) recomendada para produção⁵, R5 (5.0.0) para recursos avançados⁶
- **Java**: JDK 17 ou superior (Java 21 suportado)⁷
- **Memória**: Mínimo 4GB RAM (desenvolvimento), 8GB+ (produção)⁸
- **Armazenamento**: Mínimo 2GB para instalação base⁹

### 1.2 Bancos de Dados Suportados

- **PostgreSQL**: Recomendado com extensão TimescaleDB¹⁰
- **SQL Server**: Suporte completo para ambientes Microsoft¹¹
- **Oracle**: Para ambientes enterprise¹²
- **H2**: Apenas desenvolvimento e testes¹³

## 2. Instalação Completa Passo a Passo

### 2.1 Script de Instalação Automatizada (macOS)

```bash
#!/bin/bash
# HAPI FHIR Setup Script para macOS
set -e

echo "=== Instalação HAPI FHIR Server para Lifestyle Medicine ==="

# Instalar dependências¹⁴
brew install openjdk@17 postgresql@14 docker maven
export JAVA_HOME=/opt/homebrew/Cellar/openjdk@17/17.0.9/libexec/openjdk.jdk/Contents/Home

# Clonar projeto starter¹⁵
git clone https://github.com/hapifhir/hapi-fhir-jpaserver-starter.git
cd hapi-fhir-jpaserver-starter

echo "Instalação base concluída. Execute: ./deploy.sh"
```

### 2.2 Configuração Docker Completa

```bash
#!/bin/bash
# Docker deployment com PostgreSQL + TimescaleDB¹⁶
docker network create fhir-network

# PostgreSQL com TimescaleDB¹⁷
docker run -d \
  --name fhir-postgres \
  --network fhir-network \
  -e POSTGRES_DB=hapi \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=admin123 \
  -p 5432:5432 \
  -v fhir-postgres-data:/var/lib/postgresql/data \
  timescale/timescaledb:latest-pg14

# HAPI FHIR Server¹⁸
docker run -d \
  --name hapi-fhir-server \
  --network fhir-network \
  -p 8080:8080 \
  -e spring.datasource.url=jdbc:postgresql://fhir-postgres:5432/hapi \
  -e spring.datasource.username=admin \
  -e spring.datasource.password=admin123 \
  -e hibernate.dialect=ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgresDialect \
  hapiproject/hapi:latest

echo "Servidor disponível em: http://localhost:8080/fhir/"
```

## 3. Configuração para Medicina do Estilo de Vida

### 3.1 Application.yaml Especializado

```yaml
hapi:
  fhir:
    fhir_version: R4¹⁹
    default_encoding: json
    subscription:
      resthook_enabled: true²⁰
      websocket_enabled: true²¹
    bulk_export_enabled: true²²
    bulk_import_enabled: true
    custom-interceptor-classes:
      - com.example.interceptors.WearableDataInterceptor
      - com.example.interceptors.LifestyleMedicineInterceptor

spring:
  datasource:
    url: 'jdbc:postgresql://localhost:5432/hapi'²³
    username: admin
    password: admin123
    driverClassName: org.postgresql.Driver
  jpa:
    properties:
      hibernate.dialect: ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgresDialect²⁴

# TimescaleDB para dados de série temporal²⁵
timescaledb:
  enabled: true
  chunk_time_interval: 1d
  compression_enabled: true
```

### 3.2 Recursos FHIR para Wearables

#### Device Resource para Smartwatch²⁶

```json
{
  "resourceType": "Device",
  "id": "apple-watch-series-8",
  "identifier": [{
    "system": "http://apple.com/watch/serial",
    "value": "MW2A3LL/A-ABC123"
  }],
  "displayName": "Apple Watch Series 8",
  "status": "active",
  "manufacturer": "Apple Inc.",
  "property": [{
    "type": {
      "coding": [{
        "system": "http://snomed.info/sct",
        "code": "182777000",
        "display": "Monitor de frequência cardíaca"
      }]
    }
  }]
}
```

#### Observation para Frequência Cardíaca²⁷

```json
{
  "resourceType": "Observation",
  "status": "final",
  "category": [{
    "coding": [{
      "system": "http://terminology.hl7.org/CodeSystem/observation-category",
      "code": "vital-signs"
    }]
  }],
  "code": {
    "coding": [{
      "system": "http://loinc.org",
      "code": "8867-4",
      "display": "Heart rate"
    }]
  },
  "subject": {"reference": "Patient/patient-001"},
  "device": {"reference": "Device/apple-watch-series-8"},
  "effectiveDateTime": "2024-01-15T14:30:00-03:00",
  "valueQuantity": {
    "value": 72,
    "unit": "beats/minute",
    "system": "http://unitsofmeasure.org",
    "code": "/min"
  }
}
```

## 4. Segurança e Compliance (LGPD, GDPR, HIPAA)

### 4.1 Implementação OAuth 2.0

```java
@Component
public class OAuth2AuthorizationInterceptor extends AuthorizationInterceptor {
    
    @Override
    public List<IAuthRule> buildRuleList(RequestDetails theRequestDetails) {
        String authHeader = theRequestDetails.getHeader("Authorization");²⁸
        
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            return new RuleBuilder().deny("Token inválido").build();
        }

        OAuth2Claims claims = validateToken(authHeader.substring(7));²⁹
        
        return new RuleBuilder()
            .allow("Acesso autenticado")
            .read().write()
            .resourcesOfType(Patient.class, Observation.class)
            .inCompartment("Patient", new IdType("Patient/" + claims.getPatientId()))
            .build();
    }
}
```

### 4.2 Configuração LGPD/GDPR

```yaml
security:
  encryption:
    algorithm: "AES-256-GCM"³⁰
    key_rotation_days: 90³¹
  tls:
    version: "1.3"³²
  headers:
    strict_transport_security: "max-age=31536000; includeSubDomains; preload"³³
    content_security_policy: "default-src 'none'; frame-ancestors 'none'"³⁴

audit:
  log_format: "FHIR_AUDIT"³⁵
  retention_days: 2555  # 7 anos HIPAA³⁶
  encryption_enabled: true
```

## 5. Mapeamento de Terminologias

### 5.1 LOINC Codes para Wearables

```yaml
terminologies:
  vital_signs:
    heart_rate: "8867-4"³⁷
    blood_pressure_systolic: "8480-6"³⁸
    oxygen_saturation: "2708-6"³⁹
    heart_rate_variability: "80404-7"⁴⁰
  physical_activity:
    step_count_24h: "41950-7"⁴¹
    moderate_physical_activity: "77592-4"⁴²
  sleep:
    sleep_duration: "93832-4"⁴³
    sleep_efficiency: "93831-6"⁴⁴
  nutrition:
    caloric_intake: "33747-0"⁴⁵
    water_intake: "73985-4"⁴⁶
```

### 5.2 SNOMED-CT Mappings

```yaml
snomed_ct_mappings:
  physical_activity:
    walking: "129006008"⁴⁷
    running: "418060005"⁴⁸
    cycling: "70582002"⁴⁹
  sleep_patterns:
    sleep_duration: "248263006"⁵⁰
    sleep_quality: "248262001"⁵¹
  stress_management:
    meditation: "276239002"⁵²
    stress_reduction: "385893007"⁵³
```

## 6. Integração com Padrões de Interoperabilidade

### 6.1 openEHR Integration

```yaml
openehr:
  integration:
    enabled: true
    repository_url: "https://openehr.example.com/ehrbase/rest/openehr/v1"⁵⁴
  transformations:
    - source: "openEHR.Composition"
      target: "FHIR.Bundle"
      mapping_file: "/config/openehr-to-fhir-mappings.yaml"⁵⁵
```

### 6.2 OMOP CDM Mapping

```sql
-- View para integração OMOP⁵⁶
CREATE VIEW fhir_patient_omop AS
SELECT 
  p.person_id,
  CONCAT('{
    "resourceType": "Patient",
    "id": "', p.person_id, '",
    "gender": "', 
    CASE p.gender_concept_id 
      WHEN 8507 THEN 'male'
      WHEN 8532 THEN 'female'
      ELSE 'unknown'
    END, '"
  }') as fhir_resource
FROM person p;
```

### 6.3 IHE Profile Integration

```yaml
ihe:
  profiles:
    mhd: true  # Mobile Health Documents⁵⁷
    pixm: true # Patient Identifier Cross-Reference⁵⁸
    pdqm: true # Patient Demographics Query⁵⁹
  endpoints:
    xcad: "https://xcad.example.com"⁶⁰
```
    